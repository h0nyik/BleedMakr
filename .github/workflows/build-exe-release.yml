name: Build EXE Release

on:
  push:
    tags:
      - 'v*'  # Spust√≠ se p≈ôi push tag zaƒç√≠naj√≠c√≠ho v (nap≈ô. v0.0.1)
  workflow_dispatch:  # Umo≈æn√≠ manu√°ln√≠ spu≈°tƒõn√≠

jobs:
  build-exe:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Download UPX
      run: |
        Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v4.2.2/upx-4.2.2-win64.zip" -OutFile "upx.zip"
        Expand-Archive -Path "upx.zip" -DestinationPath "."
        Move-Item "upx-4.2.2-win64\upx.exe" "upx.exe"
        echo "$PWD" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        
    - name: Build EXE
      run: |
        python build_exe.py
        
    - name: Test EXE
      run: |
        if (Test-Path "dist/BleedMakr.exe") {
          Write-Host "‚úÖ BleedMakr.exe byl √∫spƒõ≈°nƒõ vytvo≈ôen"
          $size = (Get-Item "dist/BleedMakr.exe").Length / 1MB
          Write-Host "   Velikost: $([math]::Round($size, 1)) MB"
        } else {
          Write-Host "‚ùå BleedMakr.exe nebyl vytvo≈ôen"
          exit 1
        }
        
    - name: Get version
      id: version
      run: |
        $version = Get-Content "version.txt" -Raw
        $version = $version.Trim()
        echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        release_name: BleedMakr v${{ steps.version.outputs.VERSION }}
        body: |
          # BleedMakr v${{ steps.version.outputs.VERSION }}
          
          ## üé® Profesion√°ln√≠ gener√°tor spad√°vek pro reklamn√≠ agentury
          
          ### ‚ú® Funkce:
          - ‚úÖ **Perfektn√≠ napojen√≠ spad√°vky** s color matching algoritmem
          - ‚úÖ **Zachov√°n√≠ vektorov√© kvality** PDF
          - ‚úÖ **Inteligentn√≠ detekce okraj≈Ø** s automatick√Ωm o≈ôez√°n√≠m
          - ‚úÖ **Modern√≠ GUI** s drag&drop podporou
          - ‚úÖ **Podpora form√°t≈Ø**: PDF, EPS, PNG, JPG, TIFF
          - ‚úÖ **Batch zpracov√°n√≠** v√≠ce soubor≈Ø
          - ‚úÖ **Export do PDF** s vysok√Ωm rozli≈°en√≠m (300 DPI)
          
          ### üìã Po≈æadavky:
          - **Windows 10/11** (64-bit)
          - **Minim√°lnƒõ 4GB RAM**
          - **500MB voln√©ho m√≠sta**
          - **Ghostscript** (pro EPS soubory) - voliteln√©
          
          ### üöÄ Instalace:
          1. St√°hnƒõte `BleedMakr-v${{ steps.version.outputs.VERSION }}-Windows-x64.zip`
          2. Rozbalte do libovoln√© slo≈æky
          3. Spus≈•te `BleedMakr.exe`
          
          ### üîß Pou≈æit√≠:
          1. P≈ôet√°hnƒõte soubory do aplikace nebo kliknƒõte "P≈ôidat soubory"
          2. Nastavte velikost spad√°vky (v√Ωchoz√≠: 3 mm)
          3. Vyberte v√Ωstupn√≠ slo≈æku
          4. Kliknƒõte "Generovat spad√°vky"
          
          ---
          
          **Licence:** AGPL-3.0 | **Podpora:** [GitHub Issues](https://github.com/h0nyik/BleedMakr/issues)
        draft: false
        prerelease: false
        
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./BleedMakr-v${{ steps.version.outputs.VERSION }}-Windows-x64.zip
        asset_name: BleedMakr-v${{ steps.version.outputs.VERSION }}-Windows-x64.zip
        asset_content_type: application/zip
        
    - name: Upload EXE Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/BleedMakr.exe
        asset_name: BleedMakr.exe
        asset_content_type: application/octet-stream 